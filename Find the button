local player = game.Players.LocalPlayer
local pGui = player:WaitForChild("PlayerGui")
local runService = game:GetService("RunService")

-- 1. Main UI Container
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ButtonGodUI"
screenGui.Parent = pGui
screenGui.ResetOnSpawn = false

-- 2. Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 180, 0, 160)
mainFrame.Position = UDim2.new(0.1, 0, 0.4, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
mainFrame.Active = true
mainFrame.Draggable = true 
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 12)

local layout = Instance.new("UIListLayout")
layout.Parent = mainFrame
layout.Padding = UDim.new(0, 5)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
layout.VerticalAlignment = Enum.VerticalAlignment.Center

local function createBtn(text, color)
    local b = Instance.new("TextButton")
    b.Size = UDim2.new(0, 160, 0, 30)
    b.BackgroundColor3 = color
    b.Text = text
    b.TextColor3 = Color3.new(1, 1, 1)
    b.Font = Enum.Font.GothamBold
    b.TextSize = 12
    b.Parent = mainFrame
    Instance.new("UICorner", b)
    return b
end

local espBtn = createBtn("ESP & TRACER: OFF", Color3.fromRGB(60, 60, 60))
local clickBtn = createBtn("AUTO-CLICK: OFF", Color3.fromRGB(60, 60, 60))
local infBtn = createBtn("INFINITE CLICK: OFF", Color3.fromRGB(60, 60, 60))
local hideBtn = createBtn("HIDE UI", Color3.fromRGB(150, 0, 0))

local showBtn = Instance.new("TextButton")
showBtn.Size = UDim2.new(0, 60, 0, 30)
showBtn.Position = UDim2.new(0, 10, 0, 10)
showBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
showBtn.Text = "SHOW"
showBtn.TextColor3 = Color3.new(1, 1, 1)
showBtn.Visible = false
showBtn.Parent = screenGui
Instance.new("UICorner", showBtn)

--- LOGIC ---
local espOn, clickOn, infOn = false, false, false
local currentHighlight = nil
local currentBeam = nil
local attachment0 = nil -- Part of character
local attachment1 = nil -- Part of button

local function getTargetButton()
    local levelStat = player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Level")
    if levelStat then
        local folder = game.Workspace:FindFirstChild("Levels") and game.Workspace.Levels:FindFirstChild(tostring(levelStat.Value))
        return folder and folder:FindFirstChild("ButtonModel") and folder.ButtonModel:FindFirstChild("Button")
    end
end

-- Function to clear visuals
local function clearVisuals()
    if currentHighlight then currentHighlight:Destroy(); currentHighlight = nil end
    if currentBeam then currentBeam:Destroy(); currentBeam = nil end
    if attachment0 then attachment0:Destroy(); attachment0 = nil end
    if attachment1 then attachment1:Destroy(); attachment1 = nil end
end

local function updateESP()
    clearVisuals()
    if not espOn then return end
    
    local target = getTargetButton()
    local char = player.Character
    if target and char and char:FindFirstChild("HumanoidRootPart") then
        -- 1. Create Rainbow Highlight
        local h = Instance.new("Highlight")
        h.Parent = target
        h.OutlineColor = Color3.new(1, 1, 1)
        h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        currentHighlight = h
        
        -- 2. Create Tracer Beam
        attachment0 = Instance.new("Attachment", char.HumanoidRootPart)
        attachment1 = Instance.new("Attachment", target)
        
        local beam = Instance.new("Beam")
        beam.Attachment0 = attachment0
        beam.Attachment1 = attachment1
        beam.Width0 = 0.2
        beam.Width1 = 0.2
        beam.FaceCamera = true
        beam.ZOffset = 1
        beam.Parent = char.HumanoidRootPart
        currentBeam = beam

        -- Rainbow Loop for both Highlight and Beam
        task.spawn(function()
            local i = 0
            while currentHighlight == h and currentBeam == beam do
                local color = Color3.fromHSV(i, 1, 1)
                h.FillColor = color
                beam.Color = ColorSequence.new(color)
                i = (i + 0.01) % 1
                task.wait(0.03)
            end
        end)
    end
end

-- Button Logic
espBtn.MouseButton1Click:Connect(function()
    espOn = not espOn
    espBtn.Text = espOn and "ESP & TRACER: ON" or "ESP & TRACER: OFF"
    espBtn.BackgroundColor3 = espOn and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(60, 60, 60)
    updateESP()
end)

clickBtn.MouseButton1Click:Connect(function()
    clickOn = not clickOn
    clickBtn.Text = clickOn and "AUTO: ON" or "AUTO: OFF"
    clickBtn.BackgroundColor3 = clickOn and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(60, 60, 60)
end)

infBtn.MouseButton1Click:Connect(function()
    infOn = not infOn
    infBtn.Text = infOn and "INFINITE: ON" or "INFINITE: OFF"
    infBtn.BackgroundColor3 = infOn and Color3.fromRGB(180, 0, 180) or Color3.fromRGB(60, 60, 60)
end)

hideBtn.MouseButton1Click:Connect(function() mainFrame.Visible = false showBtn.Visible = true end)
showBtn.MouseButton1Click:Connect(function() mainFrame.Visible = true showBtn.Visible = false end)

-- Master Loop for Clicking
task.spawn(function()
    while true do
        local target = getTargetButton()
        if target then
            if infOn then
                local cd = target:FindFirstChildOfClass("ClickDetector")
                if cd then fireclickdetector(cd) end
                if target:FindFirstChild("TouchInterest") and player.Character then
                    firetouchinterest(target, player.Character.PrimaryPart, 0)
                    firetouchinterest(target, player.Character.PrimaryPart, 1)
                end
            elseif clickOn and player.Character then
                local dist = (player.Character.PrimaryPart.Position - target.Position).Magnitude
                if dist < 12 then
                    local cd = target:FindFirstChildOfClass("ClickDetector")
                    if cd then fireclickdetector(cd) end
                end
            end
        end
        task.wait(0.1)
    end
end)

-- Update Tracer and ESP when leveling up
player:WaitForChild("leaderstats"):WaitForChild("Level").Changed:Connect(function()
    task.wait(0.5)
    if espOn then updateESP() end
end)
