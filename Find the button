local player = game.Players.LocalPlayer
local pGui = player:WaitForChild("PlayerGui")

-- 1. Main Container
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "CustomESGGui"
screenGui.Parent = pGui
screenGui.ResetOnSpawn = false

-- 2. Draggable Main Button
local mainBtn = Instance.new("TextButton")
mainBtn.Name = "MainButton"
mainBtn.Size = UDim2.new(0, 160, 0, 50)
mainBtn.Position = UDim2.new(0.1, 0, 0.5, 0)
mainBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
mainBtn.Text = "ESP: OFF"
mainBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
mainBtn.Font = Enum.Font.GothamBold
mainBtn.TextSize = 16
mainBtn.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 12)
corner.Parent = mainBtn

-- 3. Small "Hide" Toggle Button
local hideBtn = Instance.new("TextButton")
hideBtn.Size = UDim2.new(0, 40, 0, 20)
hideBtn.Position = UDim2.new(1, -45, 0, 5)
hideBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
hideBtn.Text = "HIDE"
hideBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
hideBtn.Font = Enum.Font.SourceSans
hideBtn.TextSize = 10
hideBtn.Parent = mainBtn

local hideCorner = Instance.new("UICorner")
hideCorner.CornerRadius = UDim.new(0, 6)
hideCorner.Parent = hideBtn

-- 4. Restore Button (Visible when main is hidden)
local restoreBtn = Instance.new("TextButton")
restoreBtn.Size = UDim2.new(0, 60, 0, 30)
restoreBtn.Position = UDim2.new(0, 10, 0, 10)
restoreBtn.Text = "SHOW"
restoreBtn.Visible = false
restoreBtn.Parent = screenGui
Instance.new("UICorner", restoreBtn).CornerRadius = UDim.new(0, 8)

--- DRAGGING LOGIC ---
local dragging, dragInput, dragStart, startPos
mainBtn.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = mainBtn.Position
    end
end)
mainBtn.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)
game:GetService("UserInputService").InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        mainBtn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
mainBtn.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

--- ESP LOGIC ---
local espEnabled = false
local currentHighlight = nil

local function applyESP(targetPart)
    if currentHighlight then currentHighlight:Destroy() end
    local h = Instance.new("Highlight")
    h.Parent = targetPart
    h.OutlineColor = Color3.fromRGB(255, 255, 255) -- White Outline
    h.FillTransparency = 0.4
    h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    currentHighlight = h
    task.spawn(function()
        local i = 0
        while currentHighlight == h do
            h.FillColor = Color3.fromHSV(i, 0.8, 1)
            i = (i + 0.01) % 1
            task.wait(0.03)
        end
    end)
end

local function findLevelButton()
    if not espEnabled then return end
    local levelStat = player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Level")
    if levelStat then
        local path = game.Workspace:FindFirstChild("Levels") and game.Workspace.Levels:FindFirstChild(tostring(levelStat.Value))
        local btn = path and path:FindFirstChild("ButtonModel") and path.ButtonModel:FindFirstChild("Button")
        if btn then applyESP(btn) end
    end
end

--- UI BUTTON ACTIONS ---
mainBtn.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    mainBtn.Text = espEnabled and "ESP: ON" or "ESP: OFF"
    mainBtn.BackgroundColor3 = espEnabled and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(40, 40, 40)
    if espEnabled then findLevelButton() else if currentHighlight then currentHighlight:Destroy() end end
end)

hideBtn.MouseButton1Click:Connect(function()
    mainBtn.Visible = false
    restoreBtn.Visible = true
end)

restoreBtn.MouseButton1Click:Connect(function()
    mainBtn.Visible = true
    restoreBtn.Visible = false
end)

-- Auto-update on level change
player:WaitForChild("leaderstats"):WaitForChild("Level").Changed:Connect(findLevelButton)
